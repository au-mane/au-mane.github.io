import{s as d}from"./supabase-config.Y8iSvhNi.js";import{w as c,d as _}from"./index.CRsH-7pe.js";import{A as y}from"./scheduler.Ban6yQD2.js";import{s as q,p as g,f as v,g as W,c as X}from"./DateField.CnMEFLMI.js";import{t as b,U as w,g as Y}from"./app.state.FCPSyn6H.js";function I(t,e){const a=q(t),s=q(e);return+a==+s}function Z(t,e){const a=b(t),s=b(e);return a.getTime()>s.getTime()}function tt(t,e){const a=b(t),s=b(e);return+a<+s}const C=c([]);let S=!1;async function F(){if(S)return y(C);S=!0;const{data:t,error:e}=await d.from("budgets").select("*").order("start_at",{ascending:!0});if(e)throw e;const a=t||[];return C.set(a),S=!1,a}async function Mt(t){const{data:e,error:a}=await d.from("budgets").insert([t]).select();if(a)throw a;return await F(),e?e[0]:void 0}async function _t(t,e){const{data:a,error:s}=await d.from("budgets").update(e).eq("id",t).select();if(s)throw s;return await F(),a?a[0]:void 0}async function bt(t){const{error:e}=await d.from("budgets").delete().eq("id",t);if(e)throw e;await F()}const $=c([]);let B=!1;async function E(t="",e=""){if(B)return y($);B=!0;let a=[];if(t&&e){const s=`${e}T23:59:59`,{data:o,error:p}=await d.from("transactions").select("*").gte("date",t).lte("date",s).order("date",{ascending:!1});if(p)throw p;a=o||[],$.set(a)}else{const{data:s,error:o}=await d.from("transactions").select("*").order("date",{ascending:!1});if(o)throw o;a=s||[],$.set(a)}return B=!1,a}async function et(t){const{data:e,error:a}=await d.from("transactions").insert([t]).select();if(a)throw a;return await E(),e?e[0]:void 0}async function at(t,e){const{data:a,error:s}=await d.from("transactions").update(e).eq("id",t).select();if(s)throw s;return await E(),a?a[0]:void 0}async function st(t){const{error:e}=await d.from("transactions").delete().eq("id",t);if(e)throw e;await E()}function nt(t){const e={};return t.forEach(a=>{const s=a.date.split("T")[0];e[s]||(e[s]=[]),e[s].push(a)}),Object.entries(e).map(([a,s])=>({dateStr:a,transactions:s}))}const Et=t=>t?v(g(t,"yyyy-MM-dd",new Date),"MMM dd, EEEE"):"",rt=t=>t.map(e=>({id:e?.id||0,start:e?.start_at?v(g(e.start_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",end:e?.end_at?v(g(e.end_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",max_spending_limit:e?.settings?.max_spend_limit??0}));function At(t){const e=new Date;return t.find(a=>{if(a.start_at&&a.end_at){const s=g(a.start_at.split("T")[0],"yyyy-MM-dd",new Date),o=g(a.end_at.split("T")[0],"yyyy-MM-dd",new Date);return I(e,s)||I(e,o)||Z(e,s)&&tt(e,o)}return!1})}let T=null;const ot=()=>{const t=c(!1),e=c([]),a=c([]),s=c(void 0),o=c(void 0),p=c([]),h=c([]),O=c(void 0),m=_([h],([r])=>rt(r)),L=_([e],([r])=>r.reduce((n,{amount:i,meta_data:l})=>l?.paid==="yes"?n+i:n,0)),N=_([e],([r])=>r.reduce((n,{amount:i,meta_data:l})=>l?.paid==="no"?n+i:n,0)),P=_([e],([r])=>r.reduce((n,{amount:i,meta_data:l})=>l?.paid==="scheduled"?n+i:n,0)),U=c(""),x=c("");let R,j;return T={stores:{loading:t,data:e,dbData:a,dayTransactions:p,startDate:U,endDate:x,targetBudget:s,targetTransaction:o,budgetPeriods:m,budgetEntries:h,currentBudgetEntry:O,moneySpent:L,moneyNotSpent:N,moneyScheduled:P},actions:{reload:async(r=!1)=>{t.set(!0);const n=y(U),i=y(x);if(r||R!==n&&j!==i){let l=function(A){const D=new Map;return A.filter(u=>{if(u.meta_data){const M=`${u.meta_data.bill_id}_${u.date.split("T")[0]}`;return D.has(M)&&!u?.id?!1:(D.set(M,u),!0)}return!1})};R=n,j=i;const{stores:{billAsDBTransactions:V,billAsDBTransactionsStartDateStr:G,billAsDBTransactionsEndDateStr:z},actions:{reload:H}}=W();G.set(n),z.set(i),await H();const J=y(V),K=[...await E(n,i),...J].sort((A,D)=>{const u=g(A.date,"yyyy-MM-dd",new Date),M=g(D.date,"yyyy-MM-dd",new Date);return X(M,u)}),k=l(K);e.set(k);const Q=nt(k);p.set(Q)}t.set(!1)},createTransaction:async r=>{t.set(!0);try{await et(r)}catch(n){console.error(n)}finally{t.set(!1)}},updateTransaction:async(r,n)=>{t.set(!0);try{await at(r,n)}catch(i){console.error(i)}finally{t.set(!1)}},deleteTransaction:async r=>{t.set(!0);try{await st(r)}catch(n){console.error(n)}finally{t.set(!1)}}}},T},St=()=>T?.stores&&Object.keys(T.stores).length>0?T:ot(),$t=()=>{T=null};var ct=(t=>(t.UseNewTransactionsForm="use-new-transactions-form",t.UseNewBudgetPage="use-new-budget-page",t))(ct||{});const it=[{name:"use-new-transactions-form",roles:[w.Root,w.Admin,w.Authenticated],on:!0},{name:"use-new-budget-page",roles:[w.Root,w.Admin,w.Authenticated],on:!0}],{stores:{currentUser:dt}}=Y();let f=null;const lt=()=>{const t=c(it);return f={stores:{featureFlags:t},actions:{featureIsEnabled:a=>{const o=y(t).find(m=>m.name===a);if(!o)return!1;const h=y(dt).role;return!!o.roles.find(m=>m===h)&&o.on}}},f},Bt=()=>f?.stores&&Object.keys(f.stores).length>0&&f?.actions&&Object.keys(f.actions).length>0?f:lt();export{ct as F,St as a,Bt as b,Mt as c,bt as d,at as e,et as f,F as g,st as h,Et as i,At as j,$t as k,_t as u};
