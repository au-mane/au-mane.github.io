import{s as d}from"./supabase-config.Y8iSvhNi.js";import{w as c,d as m}from"./index.CaGA8Eob.js";import{A as p}from"./scheduler.C4kY8riC.js";import{s as j,p as u,f as E,g as U,c as V}from"./bills.state.CSOLRuxv.js";import{t as D}from"./app.state.B-eiuzT1.js";function k(e,t){const a=j(e),s=j(t);return+a==+s}function W(e,t){const a=D(e),s=D(t);return a.getTime()>s.getTime()}function X(e,t){const a=D(e),s=D(t);return+a<+s}const C=c([]);let _=!1;async function S(){if(_)return p(C);_=!0;const{data:e,error:t}=await d.from("budgets").select("*").order("start_at",{ascending:!0});if(t)throw t;const a=e||[];return C.set(a),_=!1,a}async function pt(e){const{data:t,error:a}=await d.from("budgets").insert([e]).select();if(a)throw a;return await S(),t?t[0]:void 0}async function wt(e,t){const{data:a,error:s}=await d.from("budgets").update(t).eq("id",e).select();if(s)throw s;return await S(),a?a[0]:void 0}async function Tt(e){const{error:t}=await d.from("budgets").delete().eq("id",e);if(t)throw t;await S()}const b=c([]);let B=!1;async function h(e="",t=""){if(B)return p(b);B=!0;let a=[];if(e&&t){const s=`${t}T23:59:59`,{data:i,error:y}=await d.from("transactions").select("*").gte("date",e).lte("date",s).order("date",{ascending:!1});if(y)throw y;a=i||[],b.set(a)}else{const{data:s,error:i}=await d.from("transactions").select("*").order("date",{ascending:!1});if(i)throw i;a=s||[],b.set(a)}return B=!1,a}async function Y(e){const{data:t,error:a}=await d.from("transactions").insert([e]).select();if(a)throw a;return await h(),t?t[0]:void 0}async function Z(e,t){const{data:a,error:s}=await d.from("transactions").update(t).eq("id",e).select();if(s)throw s;return await h(),a?a[0]:void 0}async function tt(e){const{error:t}=await d.from("transactions").delete().eq("id",e);if(t)throw t;await h()}function et(e){const t={};return e.forEach(a=>{const s=a.date.split("T")[0];t[s]||(t[s]=[]),t[s].push(a)}),Object.entries(t).map(([a,s])=>({dateStr:a,transactions:s}))}const gt=e=>e?E(u(e,"yyyy-MM-dd",new Date),"MMM dd, EEEE"):"",at=e=>e.map(t=>({id:t?.id||0,start:t?.start_at?E(u(t.start_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",end:t?.end_at?E(u(t.end_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",max_spending_limit:t?.settings?.max_spend_limit??0}));function mt(e){const t=new Date;return e.find(a=>{if(a.start_at&&a.end_at){const s=u(a.start_at.split("T")[0],"yyyy-MM-dd",new Date),i=u(a.end_at.split("T")[0],"yyyy-MM-dd",new Date);return k(t,s)||k(t,i)||W(t,s)&&X(t,i)}return!1})}let w=null;const st=()=>{const e=c(!1),t=c([]),a=c([]),s=c(void 0),i=c(void 0),y=c([]),$=c([]),R=c(void 0),L=m([$],([r])=>at(r)),N=m([t],([r])=>r.reduce((n,{amount:o,meta_data:l})=>l?.paid==="yes"?n+o:n,0)),P=m([t],([r])=>r.reduce((n,{amount:o,meta_data:l})=>l?.paid==="no"?n+o:n,0)),z=m([t],([r])=>r.reduce((n,{amount:o,meta_data:l})=>l?.paid==="scheduled"?n+o:n,0)),v=c(""),A=c("");let O,x;return w={stores:{loading:e,data:t,dbData:a,dayTransactions:y,startDate:v,endDate:A,targetBudget:s,targetTransaction:i,budgetPeriods:L,budgetEntries:$,currentBudgetEntry:R,moneySpent:N,moneyNotSpent:P,moneyScheduled:z},actions:{reload:async(r=!1)=>{e.set(!0);const n=p(v),o=p(A);if(r||O!==n&&x!==o){let l=function(M){const T=new Map;return M.filter(f=>{if(f.meta_data){const g=`${f.meta_data.bill_id}_${f.date.split("T")[0]}`;return T.has(g)&&!f?.id?!1:(T.set(g,f),!0)}return!1})};O=n,x=o;const{stores:{billAsDBTransactions:F,billAsDBTransactionsStartDateStr:G,billAsDBTransactionsEndDateStr:H},actions:{reload:I}}=U();G.set(n),H.set(o),await I();const J=p(F),K=[...await h(n,o),...J].sort((M,T)=>{const f=u(M.date,"yyyy-MM-dd",new Date),g=u(T.date,"yyyy-MM-dd",new Date);return V(g,f)}),q=l(K);t.set(q);const Q=et(q);y.set(Q)}e.set(!1)},createTransaction:async r=>{e.set(!0);try{await Y(r)}catch(n){console.error(n)}finally{e.set(!1)}},updateTransaction:async(r,n)=>{e.set(!0);try{await Z(r,n)}catch(o){console.error(o)}finally{e.set(!1)}},deleteTransaction:async r=>{e.set(!0);try{await tt(r)}catch(n){console.error(n)}finally{e.set(!1)}}}},w},Dt=()=>w?.stores&&Object.keys(w.stores).length>0?w:st();export{Dt as a,Z as b,pt as c,Tt as d,Y as e,tt as f,S as g,gt as h,mt as i,wt as u};
