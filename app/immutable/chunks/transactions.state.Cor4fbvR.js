import{s as i}from"./supabase-config.Y8iSvhNi.js";import{w as r,d as D}from"./index.DvUi5W5L.js";import{K as p}from"./scheduler.CS-wq-7V.js";import{s as j,p as u,f as E,g as U,a as V}from"./FormSkel.rCw12tPE.js";import{t as T}from"./app.state.DvZGhdJ7.js";function k(a,t){const e=j(a),s=j(t);return+e==+s}function W(a,t){const e=T(a),s=T(t);return e.getTime()>s.getTime()}function X(a,t){const e=T(a),s=T(t);return+e<+s}const C=r([]);let _=!1;async function S(){if(_)return p(C);_=!0;const{data:a,error:t}=await i.from("budgets").select("*").order("start_at",{ascending:!0});if(t)throw t;const e=a||[];return C.set(e),_=!1,e}async function dt(a){const{data:t,error:e}=await i.from("budgets").insert([a]).select();if(e)throw e;return await S(),t?t[0]:void 0}async function it(a,t){const{data:e,error:s}=await i.from("budgets").update(t).eq("id",a).select();if(s)throw s;return await S(),e?e[0]:void 0}async function ft(a){const{error:t}=await i.from("budgets").delete().eq("id",a);if(t)throw t;await S()}const b=r([]);let B=!1;async function M(a="",t=""){if(B)return p(b);B=!0;let e=[];if(a&&t){const s=`${t}T23:59:59`,{data:o,error:y}=await i.from("transactions").select("*").gte("date",a).lte("date",s).order("date",{ascending:!1});if(y)throw y;e=o||[],b.set(e)}else{const{data:s,error:o}=await i.from("transactions").select("*").order("date",{ascending:!1});if(o)throw o;e=s||[],b.set(e)}return B=!1,e}async function lt(a){const{data:t,error:e}=await i.from("transactions").insert([a]).select();if(e)throw e;return await M(),t?t[0]:void 0}async function ut(a,t){const{data:e,error:s}=await i.from("transactions").update(t).eq("id",a).select();if(s)throw s;return await M(),e?e[0]:void 0}async function yt(a){const{error:t}=await i.from("transactions").delete().eq("id",a);if(t)throw t;await M()}function Y(a){const t={};return a.forEach(e=>{const s=e.date.split("T")[0];t[s]||(t[s]=[]),t[s].push(e)}),Object.entries(t).map(([e,s])=>({dateStr:e,transactions:s}))}const pt=a=>a?E(u(a,"yyyy-MM-dd",new Date),"MMM dd, EEEE"):"",Z=a=>a.map(t=>({id:t?.id||0,start:t?.start_at?E(u(t.start_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",end:t?.end_at?E(u(t.end_at.split("T")[0],"yyyy-MM-dd",new Date),"MMM dd"):"",max_spending_limit:t?.settings?.max_spend_limit??0}));function gt(a){const t=new Date;return a.find(e=>{if(e.start_at&&e.end_at){const s=u(e.start_at.split("T")[0],"yyyy-MM-dd",new Date),o=u(e.end_at.split("T")[0],"yyyy-MM-dd",new Date);return k(t,s)||k(t,o)||W(t,s)&&X(t,o)}return!1})}let g=null;const tt=()=>{const a=r(!1),t=r([]),e=r([]),s=r(void 0),o=r(void 0),y=r([]),v=r([]),R=r(void 0),K=D([v],([d])=>Z(d)),L=D([t],([d])=>d.reduce((n,{amount:c,meta_data:f})=>f?.paid==="yes"?n+c:n,0)),N=D([t],([d])=>d.reduce((n,{amount:c,meta_data:f})=>f?.paid==="no"?n+c:n,0)),P=D([t],([d])=>d.reduce((n,{amount:c,meta_data:f})=>f?.paid==="scheduled"?n+c:n,0)),A=r(""),O=r("");let x,$;return g={stores:{loading:a,data:t,dbData:e,dayTransactions:y,startDate:A,endDate:O,targetBudget:s,targetTransaction:o,budgetPeriods:K,budgetEntries:v,currentBudgetEntry:R,moneySpent:L,moneyNotSpent:N,moneyScheduled:P},actions:{reload:async(d=!1)=>{a.set(!0);const n=p(A),c=p(O);if(d||x!==n&&$!==c){let f=function(h){const w=new Map;return h.filter(l=>{if(l.meta_data){const m=`${l.meta_data.bill_id}_${l.date.split("T")[0]}`;return w.has(m)&&!l?.id?!1:(w.set(m,l),!0)}return!1})};x=n,$=c;const{stores:{billAsDBTransactions:z,billAsDBTransactionsStartDateStr:F,billAsDBTransactionsEndDateStr:G},actions:{reload:H}}=U();F.set(n),G.set(c),await H();const I=p(z),J=[...await M(n,c),...I].sort((h,w)=>{const l=u(h.date,"yyyy-MM-dd",new Date),m=u(w.date,"yyyy-MM-dd",new Date);return V(m,l)}),q=f(J);t.set(q);const Q=Y(q);y.set(Q)}a.set(!1)}}},g},wt=()=>g?.stores&&Object.keys(g.stores).length>0?g:tt();export{wt as a,ut as b,dt as c,ft as d,lt as e,yt as f,S as g,pt as h,gt as i,it as u};
